<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
      }

      #content {
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #24153f;
      }

      #screen {
        margin: auto;
        border: 10px solid #1a1329;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -moz-crisp-edges;
        width: 400px;
        height: 400px;
        background-color: #24153f;
        box-shadow: 0 0 24px rgba(255, 0, 162, 0.816);
      }
    </style>
  </head>
  <body>
    <div id="content">
      <canvas id="screen" width="10" height="10"></canvas>
    </div>

    <script>
      const screen = document.getElementById("screen");
      const ctx = screen.getContext("2d");
      const currentPlayer = "player1";

      function createGame() {
        const state = {
          players: {
            player1: { x: 1, y: 1 },
            player2: { x: 9, y: 9 },
          },
          fruits: {
            fruit1: { x: 3, y: 1 },
          },
        };

        function movePlayer(command) {
          console.log(
            `Moving player ${command.playerId} ${command.keyPressed}`
          );

          const acceptedMoves = {
            ArrowUp(player) {
              console.log(`Moving player up`);
              if (player.y - 1 >= 0) {
                player.y--;
                return;
              }
            },
            ArrowRight(player) {
              console.log(`Moving player right`);
              if (player.x + 1 < screen.width) {
                player.x++;
                return;
              }
            },
            ArrowDown(player) {
              console.log(`Moving player down`);
              if (player.y + 1 < screen.height) {
                player.y++;
                return;
              }
            },
            ArrowLeft(player) {
              console.log(`Moving player left`);
              if (player.x - 1 >= 0) {
                player.x--;
                return;
              }
            },
          };

          const keyPressed = command.keyPressed;
          const player = state.players[command.playerId];
          const moveFunction = acceptedMoves[keyPressed];
          if (moveFunction) moveFunction(player);
          return;
        }

        return {
          movePlayer,
          state,
        };
      }

      const game = createGame();
      const keyboardListener = createKeyboardListener();
      keyboardListener.subscribe(game.movePlayer);

      function createKeyboardListener() {
        const state = {
          observers: [],
        };

        function subscribe(observerFunction) {
          state.observers.push(observerFunction);
        }

        function notifyAll(command) {
          console.log(`Notifying ${state.observers.length} observers`);
          state.observers.forEach((observer) => observer(command));
        }

        document.addEventListener("keydown", handleKeyDown);

        function handleKeyDown(e) {
          const keyPressed = e.key;

          const command = {
            playerId: "player1",
            keyPressed,
          };

          notifyAll(command);
        }

        return {
          subscribe,
          notifyAll,
        };
      }

      renderScreen();

      function renderScreen() {
        ctx.fillStyle = "white";
        ctx.clearRect(0, 0, 10, 10);

        for (const playerId in game.state.players) {
          const player = game.state.players[playerId];
          ctx.fillStyle = "#4f1ad6";
          ctx.fillRect(player.x, player.y, 1, 1);
        }

        for (const fruitId in game.state.fruits) {
          const fruit = game.state.fruits[fruitId];
          ctx.fillStyle = "#1ac3d6";
          ctx.fillRect(fruit.x, fruit.y, 1, 1);
        }

        requestAnimationFrame(renderScreen);
      }
    </script>
  </body>
</html>
